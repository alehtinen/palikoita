<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Päivää!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#8b5cf6',
                    }
                }
            }
        }
    </script>
    <style>
        /* Tailwind JIT safelist - all possible dynamic color classes */
        .bg-blue-50,.bg-blue-100,.bg-blue-200,.bg-blue-500,.bg-blue-600,.bg-blue-700,.bg-blue-800,.bg-blue-900,
        .bg-purple-50,.bg-purple-100,.bg-purple-200,.bg-purple-500,.bg-purple-600,.bg-purple-700,.bg-purple-800,.bg-purple-900,
        .bg-green-50,.bg-green-100,.bg-green-200,.bg-green-500,.bg-green-600,.bg-green-700,.bg-green-800,.bg-green-900,
        .bg-red-50,.bg-red-100,.bg-red-200,.bg-red-500,.bg-red-600,.bg-red-700,.bg-red-800,.bg-red-900,
        .bg-yellow-50,.bg-yellow-100,.bg-yellow-200,.bg-yellow-500,.bg-yellow-600,.bg-yellow-700,.bg-yellow-800,.bg-yellow-900,
        .bg-orange-50,.bg-orange-100,.bg-orange-200,.bg-orange-500,.bg-orange-600,.bg-orange-700,.bg-orange-800,.bg-orange-900,
        .bg-pink-50,.bg-pink-100,.bg-pink-200,.bg-pink-500,.bg-pink-600,.bg-pink-700,.bg-pink-800,.bg-pink-900,
        .bg-indigo-50,.bg-indigo-100,.bg-indigo-200,.bg-indigo-500,.bg-indigo-600,.bg-indigo-700,.bg-indigo-800,.bg-indigo-900,
        .bg-cyan-50,.bg-cyan-100,.bg-cyan-200,.bg-cyan-500,.bg-cyan-600,.bg-cyan-700,.bg-cyan-800,.bg-cyan-900,
        .bg-teal-50,.bg-teal-100,.bg-teal-200,.bg-teal-500,.bg-teal-600,.bg-teal-700,.bg-teal-800,.bg-teal-900,
        .bg-gray-50,.bg-gray-100,.bg-gray-200,.bg-gray-500,.bg-gray-600,.bg-gray-700,.bg-gray-800,.bg-gray-900,
        .text-blue-200,.text-blue-400,.text-blue-600,.text-blue-800,
        .text-purple-200,.text-purple-400,.text-purple-600,.text-purple-800,
        .text-green-200,.text-green-400,.text-green-600,.text-green-800,
        .text-red-200,.text-red-400,.text-red-600,.text-red-800,
        .text-yellow-200,.text-yellow-400,.text-yellow-600,.text-yellow-800,
        .text-orange-200,.text-orange-400,.text-orange-600,.text-orange-800,
        .text-pink-200,.text-pink-400,.text-pink-600,.text-pink-800,
        .text-indigo-200,.text-indigo-400,.text-indigo-600,.text-indigo-800,
        .text-cyan-200,.text-cyan-400,.text-cyan-600,.text-cyan-800,
        .text-teal-200,.text-teal-400,.text-teal-600,.text-teal-800,
        .text-gray-200,.text-gray-400,.text-gray-600,.text-gray-800,
        .hover\:bg-blue-100,.hover\:bg-blue-700,.hover\:bg-blue-800,.hover\:bg-blue-900,
        .hover\:bg-purple-100,.hover\:bg-purple-700,.hover\:bg-purple-800,.hover\:bg-purple-900,
        .hover\:bg-green-100,.hover\:bg-green-700,.hover\:bg-green-800,.hover\:bg-green-900,
        .hover\:bg-red-100,.hover\:bg-red-700,.hover\:bg-red-800,.hover\:bg-red-900,
        .hover\:bg-yellow-100,.hover\:bg-yellow-700,.hover\:bg-yellow-800,.hover\:bg-yellow-900,
        .hover\:bg-orange-100,.hover\:bg-orange-700,.hover\:bg-orange-800,.hover\:bg-orange-900,
        .hover\:bg-pink-100,.hover\:bg-pink-700,.hover\:bg-pink-800,.hover\:bg-pink-900,
        .hover\:bg-indigo-100,.hover\:bg-indigo-700,.hover\:bg-indigo-800,.hover\:bg-indigo-900,
        .hover\:bg-cyan-100,.hover\:bg-cyan-700,.hover\:bg-cyan-800,.hover\:bg-cyan-900,
        .hover\:bg-teal-100,.hover\:bg-teal-700,.hover\:bg-teal-800,.hover\:bg-teal-900,
        .dark\:bg-blue-900,.dark\:bg-purple-900,.dark\:bg-green-900,.dark\:bg-red-900,.dark\:bg-yellow-900,
        .dark\:bg-orange-900,.dark\:bg-pink-900,.dark\:bg-indigo-900,.dark\:bg-cyan-900,.dark\:bg-teal-900,
        .dark\:text-blue-200,.dark\:text-blue-300,.dark\:text-purple-200,.dark\:text-purple-300,.dark\:text-green-200,.dark\:text-green-300,.dark\:text-red-200,.dark\:text-red-300,
        .dark\:text-yellow-200,.dark\:text-yellow-300,.dark\:text-orange-200,.dark\:text-orange-300,.dark\:text-pink-200,.dark\:text-pink-300,.dark\:text-indigo-200,.dark\:text-indigo-300,
        .dark\:text-cyan-200,.dark\:text-cyan-300,.dark\:text-teal-200,.dark\:text-teal-300,
        .dark\:hover\:bg-blue-800,.dark\:hover\:bg-blue-900,.dark\:hover\:bg-purple-800,.dark\:hover\:bg-purple-900,.dark\:hover\:bg-green-800,.dark\:hover\:bg-green-900,
        .dark\:hover\:bg-red-800,.dark\:hover\:bg-red-900,.dark\:hover\:bg-yellow-800,.dark\:hover\:bg-yellow-900,.dark\:hover\:bg-orange-800,.dark\:hover\:bg-orange-900,
        .ring-2,.ring-blue-500,.ring-purple-500,.ring-green-500,.ring-red-500,.ring-yellow-500,
        .ring-orange-500,.ring-pink-500,.ring-indigo-500,.ring-cyan-500,.ring-teal-500 { }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800 min-h-screen transition-colors duration-200">
    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <button onclick="window.close()" class="h-9 px-3 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors font-medium text-xs sm:text-sm inline-flex items-center justify-center" title="Close">←</button>
                <div>
                    <h1 id="headerTitle" class="text-lg font-bold text-gray-900 dark:text-white">Content</h1>
                    <p id="headerSubtitle" class="text-xs text-gray-600 dark:text-gray-400 mt-0.5"></p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button id="langToggle" title="Toggle language" class="h-9 px-3 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors font-medium text-xs sm:text-sm inline-flex items-center justify-center">EN</button>
                <button id="themeToggle" title="Toggle theme" class="h-9 px-3 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors font-medium text-xs sm:text-sm inline-flex items-center justify-center">
                    <svg id="sunIcon" class="w-5 h-5 hidden dark:block" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path></svg>
                    <svg id="moonIcon" class="w-5 h-5 block dark:hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                </button>
                <button id="outlineToggleBtn" class="h-9 px-3 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors font-medium text-xs sm:text-sm lg:hidden inline-flex items-center justify-center" onclick="toggleMobileOutline()" title="Outline">☰</button>
                <button id="pdfButton" onclick="downloadPDF()" class="h-9 px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors inline-flex items-center justify-center gap-2 text-xs sm:text-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                    </svg>
                    <span class="hidden sm:inline">PDF</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content with Outline Sidebar -->
    <main class="max-w-7xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-[300px_1fr] gap-6">
        <!-- Outline Sidebar (Desktop) -->
        <aside id="outline" class="hidden lg:block lg:sticky lg:top-20 lg:self-start bg-white dark:bg-gray-800 rounded-lg p-4 shadow h-fit font-sans">
            <h3 class="font-semibold mb-3 text-gray-800 dark:text-gray-100">
                <span class="lang-fi">Sisällysluettelo</span>
                <span class="lang-en">Outline</span>
            </h3>
            <nav id="outlineNav" class="text-sm space-y-1 text-gray-700 dark:text-gray-200 font-sans"></nav>
        </aside>

        <!-- Content Area -->
        <section>
            <!-- Filter Section -->
            <div class="mb-6 bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
                <button id="filterToggle" class="flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                    </svg>
                    <span class="lang-fi">Suodata kategorioita</span>
                    <span class="lang-en">Filter categories</span>
                </button>
                <div id="filterContainer" class="hidden mt-3 grid grid-cols-2 md:grid-cols-3 gap-2">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Content -->
            <div id="content" class="overflow-x-auto">
                <!-- Content will be populated by JavaScript -->
            </div>
        </section>
    </main>

    <!-- Mobile Outline Panel -->
    <div id="mobileOutlinePanel" class="fixed inset-0 z-50 hidden lg:hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50" onclick="closeMobileOutline()"></div>
        <div class="absolute right-0 top-0 bottom-0 w-3/4 max-w-xs bg-white dark:bg-gray-800 p-4 overflow-auto shadow-lg transform transition-transform duration-200">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-lg text-gray-900 dark:text-white">
                    <span class="lang-fi">Sisällysluettelo</span>
                    <span class="lang-en">Outline</span>
                </h3>
                <button onclick="closeMobileOutline()" class="p-2 text-gray-600 dark:text-gray-300">✕</button>
            </div>
            <nav id="mobileOutlineList" class="space-y-1 text-sm text-gray-700 dark:text-gray-200"></nav>
        </div>
    </div>

    <script src="loader.js"></script>
    <script src="app.js"></script>
    <script>
        // Check for debug mode in URL and load debug.js if needed
        (function() {
            const params = new URLSearchParams(window.location.search);
            let debugParam = params.get('debug');
            // Also check hash for debug parameter (e.g., #?debug=1)
            if (!debugParam && window.location.hash) {
                const hashParams = new URLSearchParams(window.location.hash.replace(/^#/, '').replace(/^\?/, ''));
                debugParam = hashParams.get('debug');
            }
            const persistParam = params.get('persist');
            
            if (debugParam === '1') {
                // Load debug.js dynamically
                const script = document.createElement('script');
                script.src = 'debug.js';
                script.async = false;
                document.head.appendChild(script);
                
                // Store debug preference unless persist=0
                if (persistParam !== '0') {
                    localStorage.setItem('debug', '1');
                }
            } else if (debugParam === '0') {
                // Disable debug mode
                localStorage.removeItem('debug');
            } else if (localStorage.getItem('debug') === '1') {
                // Load debug.js if previously enabled
                const script = document.createElement('script');
                script.src = 'debug.js';
                script.async = false;
                document.head.appendChild(script);
            }
        })();

        // Mobile outline toggle functions
        function toggleMobileOutline() {
            const panel = document.getElementById('mobileOutlinePanel');
            if (panel) panel.classList.remove('hidden');
        }

        function closeMobileOutline() {
            const panel = document.getElementById('mobileOutlinePanel');
            if (panel) panel.classList.add('hidden');
        }

        // Will be overridden by specific page type
        function downloadPDF() {
            console.log('downloadPDF not implemented');
        }

        // Setup event listeners for pageview
        function setupPageEventListeners() {
            // Language toggle
            const langToggle = document.getElementById('langToggle');
            if (langToggle) {
                langToggle.onclick = () => {
                    if (typeof toggleLanguage === 'function') toggleLanguage();
                };
            }
            
            // Theme toggle
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.onclick = () => {
                    if (typeof toggleTheme === 'function') toggleTheme();
                };
            }
        }

        // Initialize based on URL parameter
        window.addEventListener('contentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const type = params.get('type') || 'links';
            
            // Initialize theme and language first
            if (typeof applyTheme === 'function') applyTheme();
            if (typeof applyLanguage === 'function') applyLanguage();
            setupPageEventListeners();
            
            if (type === 'links') {
                setupAllLinksPage();
            } else if (type === 'contacts') {
                setupContactsPage();
            } else if (type === 'sources') {
                setupSourcesPage();
            }
        });

        function setupAllLinksPage() {
            document.getElementById('pageTitle').textContent = 'Kaikki Linkit - Päivää!';
            const headerTitle = document.querySelector('#headerTitle');
            const headerSubtitle = document.querySelector('#headerSubtitle');
            
            // Map generic IDs to specific modal IDs FIRST
            document.getElementById('content').id = 'allLinksContent';
            document.getElementById('filterContainer').id = 'allLinksFilter';
            
            // Set header content with language support
            if (headerTitle) {
                headerTitle.innerHTML = '<span class="lang-fi">Kaikki Linkit</span><span class="lang-en">All Links</span>';
            }
            if (headerSubtitle) {
                headerSubtitle.innerHTML = '<span class="lang-fi">Kaikki sivulla esiintyvät linkit</span><span class="lang-en">All links found on the site</span>';
            }
            
            // Build category filter checkboxes
            const filterContainer = document.getElementById('allLinksFilter');
            if (filterContainer && window.mainTagDefinitions) {
                filterContainer.innerHTML = '';
                Object.keys(window.mainTagDefinitions).forEach(mainTagId => {
                    const mainTagDef = window.mainTagDefinitions[mainTagId];
                    const label = document.createElement('label');
                    label.className = 'flex items-center gap-2 cursor-pointer text-sm';
                    label.innerHTML = `
                        <input type="checkbox" value="${mainTagId}" checked class="w-4 h-4 text-blue-600 rounded" onchange="renderAllLinksWithOutline()">
                        <span class="text-gray-900 dark:text-white">${mainTagDef[currentLang]}</span>
                    `;
                    filterContainer.appendChild(label);
                });
            }
            
            // Create wrapper function to rebuild outline after rendering
            window.renderAllLinksWithOutline = function() {
                renderAllLinks();
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        buildAllLinksOutline();
                    });
                });
            };
            
            downloadPDF = downloadAllLinksPDF;
            document.getElementById('filterToggle').onclick = toggleAllLinksFilter;
            
            // Apply language to header after setting innerHTML
            if (typeof applyLanguage === 'function') applyLanguage();
            
            // Render content and build outline
            renderAllLinksWithOutline();
        }

        function setupContactsPage() {
            document.getElementById('pageTitle').textContent = 'Yhteystiedot - Päivää!';
            const headerTitle = document.querySelector('#headerTitle');
            const headerSubtitle = document.querySelector('#headerSubtitle');
            
            // Map generic IDs to specific modal IDs FIRST
            document.getElementById('content').id = 'contactsContent';
            document.getElementById('filterContainer').id = 'contactsFilter';
            
            // Set header content with language support
            if (headerTitle) {
                headerTitle.innerHTML = '<span class="lang-fi">Yhteystiedot</span><span class="lang-en">Contact Information</span>';
            }
            if (headerSubtitle) {
                headerSubtitle.innerHTML = '<span class="lang-fi">Kaikki sivulla esiintyvät yhteystiedot</span><span class="lang-en">All contact information on the site</span>';
            }
            
            // Build category filter checkboxes
            const filterContainer = document.getElementById('contactsFilter');
            if (filterContainer && window.mainTagDefinitions) {
                filterContainer.innerHTML = '';
                Object.keys(window.mainTagDefinitions).forEach(mainTagId => {
                    const mainTagDef = window.mainTagDefinitions[mainTagId];
                    const label = document.createElement('label');
                    label.className = 'flex items-center gap-2 cursor-pointer text-sm';
                    label.innerHTML = `
                        <input type="checkbox" value="${mainTagId}" checked class="w-4 h-4 text-blue-600 rounded" onchange="renderContactsWithOutline()">
                        <span class="text-gray-900 dark:text-white">${mainTagDef[currentLang]}</span>
                    `;
                    filterContainer.appendChild(label);
                });
            }
            
            // Create wrapper function to rebuild outline after rendering
            window.renderContactsWithOutline = function() {
                renderContacts();
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        buildContactsOutline();
                    });
                });
            };
            
            downloadPDF = downloadContactsPDF;
            document.getElementById('filterToggle').onclick = toggleContactsFilter;
            
            // Apply language to header after setting innerHTML
            if (typeof applyLanguage === 'function') applyLanguage();
            
            // Render content and build outline
            renderContactsWithOutline();
        }

        function setupSourcesPage() {
            document.getElementById('pageTitle').textContent = 'Lähteet - Päivää!';
            const headerTitle = document.querySelector('#headerTitle');
            const headerSubtitle = document.querySelector('#headerSubtitle');
            
            // Map generic IDs to specific modal IDs FIRST
            document.getElementById('content').id = 'sourcesContent';
            document.getElementById('filterContainer').id = 'sourcesFilter';
            
            // Set header content with language support
            if (headerTitle) {
                headerTitle.innerHTML = '<span class="lang-fi">Lähteet</span><span class="lang-en">Sources</span>';
            }
            if (headerSubtitle) {
                headerSubtitle.innerHTML = '<span class="lang-fi">Kaikki sivulla käytetyt lähteet</span><span class="lang-en">All sources used on the site</span>';
            }
            
            // Build category filter checkboxes
            const filterContainer = document.getElementById('sourcesFilter');
            if (filterContainer && window.mainTagDefinitions) {
                filterContainer.innerHTML = '';
                Object.keys(window.mainTagDefinitions).forEach(mainTagId => {
                    const mainTagDef = window.mainTagDefinitions[mainTagId];
                    const label = document.createElement('label');
                    label.className = 'flex items-center gap-2 cursor-pointer text-sm';
                    label.innerHTML = `
                        <input type="checkbox" value="${mainTagId}" checked class="w-4 h-4 text-blue-600 rounded" onchange="renderSourcesWithOutline()">
                        <span class="text-gray-900 dark:text-white">${mainTagDef[currentLang]}</span>
                    `;
                    filterContainer.appendChild(label);
                });
            }
            
            // Create wrapper function to rebuild outline after rendering
            window.renderSourcesWithOutline = function() {
                renderSources();
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        buildSourcesOutline();
                    });
                });
            };
            
            downloadPDF = downloadSourcesPDF;
            document.getElementById('filterToggle').onclick = toggleSourcesFilter;
            
            // Apply language to header after setting innerHTML
            if (typeof applyLanguage === 'function') applyLanguage();
            
            // Render content and build outline
            renderSourcesWithOutline();
        }

        function buildAllLinksOutline() {
            const nav = document.getElementById('outlineNav');
            const mobileNav = document.getElementById('mobileOutlineList');
            if (!nav) return;

            const groups = Array.from(document.querySelectorAll('#allLinksContent [id^="linkGroup_"]'))
                .filter(el => !el.id.endsWith('_icon'));
            nav.innerHTML = '';
            if (mobileNav) mobileNav.innerHTML = '';

            groups.forEach(group => {
                const groupId = group.id;
                // The h3 is in the previous sibling (the header div), not in the group itself
                const title = group.previousElementSibling ? group.previousElementSibling.querySelector('h3') : null;
                if (!title) return;

                const titleText = title.textContent.replace(/\(\d+\)/, '').trim();
                
                const a = document.createElement('a');
                a.href = `#${groupId}`;
                a.className = 'flex items-center justify-between pl-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 bg-transparent text-sm font-medium text-gray-800 dark:text-gray-200';
                a.innerHTML = `<span class="truncate">${titleText}</span><svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>`;
                
                a.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetEl = document.getElementById(groupId);
                    if (targetEl) targetEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    closeMobileOutline();
                });

                nav.appendChild(a);
                if (mobileNav) {
                    const mobileLink = a.cloneNode(true);
                    mobileLink.addEventListener('click', function(e) {
                        e.preventDefault();
                        const targetEl = document.getElementById(groupId);
                        if (targetEl) targetEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        closeMobileOutline();
                    });
                    mobileNav.appendChild(mobileLink);
                }
            });
        }

        function buildContactsOutline() {
            const nav = document.getElementById('outlineNav');
            const mobileNav = document.getElementById('mobileOutlineList');
            if (!nav) return;

            const groups = Array.from(document.querySelectorAll('#contactsContent [id^="contactGroup_"]'))
                .filter(el => !el.id.endsWith('_icon'));
            nav.innerHTML = '';
            if (mobileNav) mobileNav.innerHTML = '';

            groups.forEach(group => {
                const groupId = group.id;
                // The h3 is in the previous sibling (the header div), not in the group itself
                const title = group.previousElementSibling ? group.previousElementSibling.querySelector('h3') : null;
                if (!title) return;

                const titleText = title.textContent.replace(/\(\d+\)/, '').trim();
                
                const a = document.createElement('a');
                a.href = `#${groupId}`;
                a.className = 'flex items-center justify-between pl-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 bg-transparent text-sm font-medium text-gray-800 dark:text-gray-200';
                a.innerHTML = `<span class="truncate">${titleText}</span><svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>`;
                
                a.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetEl = document.getElementById(groupId);
                    if (targetEl) targetEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    closeMobileOutline();
                });

                nav.appendChild(a);
                if (mobileNav) {
                    const mobileLink = a.cloneNode(true);
                    mobileLink.addEventListener('click', function(e) {
                        e.preventDefault();
                        const targetEl = document.getElementById(groupId);
                        if (targetEl) targetEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        closeMobileOutline();
                    });
                    mobileNav.appendChild(mobileLink);
                }
            });
        }

        function buildSourcesOutline() {
            const nav = document.getElementById('outlineNav');
            const mobileNav = document.getElementById('mobileOutlineList');
            if (!nav) return;

            const groups = Array.from(document.querySelectorAll('#sourcesContent [id^="sourceGroup_"]'))
                .filter(el => !el.id.endsWith('_icon'));
            nav.innerHTML = '';
            if (mobileNav) mobileNav.innerHTML = '';

            groups.forEach(group => {
                const groupId = group.id;
                // The h3 is in the previous sibling (the header div), not in the group itself
                const title = group.previousElementSibling ? group.previousElementSibling.querySelector('h3') : null;
                if (!title) return;

                const titleText = title.textContent.replace(/\(\d+\)/, '').trim();
                
                const a = document.createElement('a');
                a.href = `#${groupId}`;
                a.className = 'flex items-center justify-between pl-3 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 bg-transparent text-sm font-medium text-gray-800 dark:text-gray-200';
                a.innerHTML = `<span class="truncate">${titleText}</span><svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>`;
                
                a.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetEl = document.getElementById(groupId);
                    if (targetEl) targetEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    closeMobileOutline();
                });

                nav.appendChild(a);
                if (mobileNav) {
                    const mobileLink = a.cloneNode(true);
                    mobileLink.addEventListener('click', function(e) {
                        e.preventDefault();
                        const targetEl = document.getElementById(groupId);
                        if (targetEl) targetEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        closeMobileOutline();
                    });
                    mobileNav.appendChild(mobileLink);
                }
            });
        }
    </script>
</body>
</html>
